<!-- TODO inertia position of virtual links and more usefull default classes -->

<mujoco model="hand_v1">
    <compiler angle="degree" coordinate="local" inertiafromgeom="true"/>
    <option timestep="0.005" gravity="0 0 -9.81" iterations="50" integrator="Euler"/>

    <asset>
        <!-- Meshes for physical links (no visual links) -->
        <mesh name="palm_bottom" file="assets/palm_bottom.stl" scale="0.001 0.001 0.001"/>
        <mesh name="palm_top" file="assets/palm_top.stl" scale="0.001 0.001 0.001"/>
        <mesh name="palm_side_1" file="assets/palm_side_1.stl" scale="0.001 0.001 0.001"/>
        <mesh name="palm_side_2" file="assets/palm_side_2.stl" scale="0.001 0.001 0.001"/>
        <mesh name="palm_dynxl_sprt" file="assets/palm_dynxl_sprt.stl" scale="0.001 0.001 0.001"/>

        <mesh name="pointer_1" file="assets/pointer_1.stl" scale="0.001 0.001 0.001"/>
        <mesh name="pointer_2" file="assets/pointer_2.stl" scale="0.001 0.001 0.001"/>
        <mesh name="pointer_3" file="assets/pointer_3.stl" scale="0.001 0.001 0.001"/>
        <mesh name="pointer_4" file="assets/pointer_4.stl" scale="0.001 0.001 0.001"/>

        <mesh name="middle_1" file="assets/mid_1.stl" scale="0.001 0.001 0.001"/>
        <mesh name="middle_2" file="assets/mid_2.stl" scale="0.001 0.001 0.001"/>
        <mesh name="middle_3" file="assets/mid_3.stl" scale="0.001 0.001 0.001"/>
        <mesh name="middle_4" file="assets/mid_4.stl" scale="0.001 0.001 0.001"/>

        <mesh name="pinki_base" file="assets/pinki_base.stl" scale="0.001 0.001 0.001"/>
        <mesh name="pinki_1" file="assets/pinki_1.stl" scale="0.001 0.001 0.001"/>
        <mesh name="pinki_2" file="assets/pinki_2.stl" scale="0.001 0.001 0.001"/>
        <mesh name="pinki_3" file="assets/pinki_3.stl" scale="0.001 0.001 0.001"/>
        <mesh name="pinki_4" file="assets/pinki_4.stl" scale="0.001 0.001 0.001"/>

        <mesh name="dynamixel" file="assets/dynamixel.stl" scale="0.001 0.001 0.001"/>
        <mesh name="thumb_1" file="assets/thumb_1.stl" scale="0.001 0.001 0.001"/>
        <mesh name="thumb_2" file="assets/thumb_2.stl" scale="0.001 0.001 0.001"/>
        <mesh name="thumb_3" file="assets/thumb_3.stl" scale="0.001 0.001 0.001"/>
        <mesh name="thumb_4" file="assets/thumb_4.stl" scale="0.001 0.001 0.001"/>
    
        <!-- adjust scaling. stl in mm and not in m, here we choose metric system, eg, lengh 1 = 1 meter-->
    </asset>

    <default >
        <default class="class1">
            <!-- Default geom properties -->
            <geom rgba="0.4 0.6 0.5 1" type="mesh" density="662" friction="1 0.005 0.001" condim="3" margin="0.0005" contype="1" conaffinity="1"/>
            <!-- Default joint properties -->
            <joint type="hinge" limited="true" damping="0.05" armature="0.001" margin="0.01" frictionloss="0.001"/>
            <!-- Default actuator properties -->
            <position ctrllimited="true" forcelimited="true" forcerange="-000.1 000.1" kp="2."/>
            <!-- Default tendon properties -->
            <tendon limited="true" range="-0.001 0.001"/>
        </default>
    
        <default class="class2">
            <!-- Default geom properties -->
            <geom rgba="0.7 0.3 0.3 1" type="mesh" density="662" friction="1 0.005 0.001" condim="3" margin="0.0005" contype="1" conaffinity="1"/>
            <!-- Default joint properties -->
            <joint type="hinge" limited="true" damping="0.05" armature="0.001" margin="0.01" frictionloss="0.001"/>
            <!-- Default actuator properties -->
            <position ctrllimited="true" forcelimited="true" forcerange="-1 1" kp="2."/>
        </default>

        <position ctrllimited="true" forcelimited="true" forcerange="-2 2" kp="2."/>
        <joint type="hinge" limited="true" damping="0.05" armature="0.01" margin="0.01" frictionloss="0.001"/>
        <!-- Default tendon properties -->
        <tendon limited="true" range="-0.001 0.001"/>
    </default>


    <worldbody>
        <light diffuse=".5 .5 .5" pos="0 0 3" dir="0 0 -1"/>

        <!-- sphere in hand -->
        <body>
            <geom type="sphere" size="0.0325" rgba="1 1 0 0.5" pos="0 0 0.0326" mass="0.1" friction="1 0.005 0.001"/>
            <freejoint/>
        </body>
        
        <!-- Hand: Base link, palm-->
        <body name="Palm" pos="0 0 0">
            <!-- Palm geoms-->
            <geom type="mesh" mesh="palm_bottom" mass = "0.1" class="class1"/>
            <geom type="mesh" mesh="palm_top" mass = "0.1" class="class1"/>
            <geom type="mesh" mesh="palm_side_1" mass = "0.1" class="class1"/>
            <geom type="mesh" mesh="palm_side_2" mass = "0.1" class="class1"/>
            <geom type="mesh" mesh="palm_dynxl_sprt" mass = "0.1" class="class1"/>

            <!-- Pointer 2Dof ############################################################################################################-->
            <geom type="mesh" mesh="pointer_1" mass = "0.05" class="class1"/>

            <!-- Virtual link for first rolling joint -->
            <body name="pointer_virtual_link_1" pos="0 0 0"> 
                <joint type="hinge" name="pointer_virtual_joint_1" axis="0.91 -0.42 0" pos="0.0423911 0.0456619 -0.010" range="-1 45"/>               
                <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 

                <!-- Second link -->
                <body name="pointer_2" pos="0 0 0">
                    <joint type="hinge" name="pointer_joint_1" axis="0.91 -0.42 0" pos="0.0508435 0.063788 -0.01" range="-1 45"/> 
                    <geom type="mesh" mesh="pointer_2" class="class2" mass = "0.05"/>

                    <!-- Virtual link for second rolling joint -->
                    <body name="pointer_virtual_link_2" pos="0 0 0"> 
                        <joint type="hinge" name="pointer_virtual_joint_2" axis="0.91 -0.42 0" pos="0.061409 0.0864457 -0.01" range="-1 45"/>               
                        <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 
        
                        <!-- Third link -->
                        <body name="pointer_3" pos="0 0 0">
                            <joint type="hinge" name="pointer_joint_2" axis="0.91 -0.42 0" pos="0.0698613 0.1045719 -0.01" range="-1 45"/> 
                            <geom type="mesh" mesh="pointer_3" class="class2" mass = "0.05"/>

                            <!-- Virtual link for third rolling joint -->
                            <body name="pointer_virtual_link_3" pos="0 0 0"> 
                                <joint type="hinge" name="pointer_virtual_joint_3" axis="0.91 -0.42 0" pos="0.0740875 0.1126349 -0.01" range="-1 45"/>               
                                <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 
                
                                <!-- Fourth link -->
                                <body name="pointer_4" pos="0 0 0">
                                    <joint type="hinge" name="pointer_joint_3" axis="0.91 -0.42 0" pos="0.0825399 0.1317611 -0.01" range="-1 45"/> 
                                    <geom type="mesh" mesh="pointer_4" class="class2" mass = "0.05"/>

                                </body>
                            </body>
                        </body>
                    </body>
                </body>
            </body>


            <!-- Middle finger 2Dof ############################################################################################################-->
            <geom type="mesh" mesh="middle_1" mass = "0.1" class="class1"/>

            <!-- Virtual link for first rolling joint -->
            <body name="middle_virtual_link_1" pos="0 0 0"> 
                <joint type="hinge" name="middle_virtual_joint_1" axis="1 0 0" pos="0.08 0.0568333 -0.01" range="-1 45"/>               
                <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 

                <!-- Second link -->
                <body name="middle_2" pos="0 0 0">
                    <joint type="hinge" name="middle_joint_1" axis="1 0 0" pos="0.008 0.0768333 -0.01" range="-1 45"/> 
                    <geom type="mesh" mesh="middle_2" class="class2" mass = "0.1"/>

                    <!-- Virtual link for second rolling joint -->
                    <body name="middle_virtual_link_2" pos="0 0 0"> 
                        <joint type="hinge" name="middle_virtual_joint_2" axis="1 0 0" pos="0.008 0.1018333 -0.01" range="-1 45"/>               
                        <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 
        
                        <!-- Third link -->
                        <body name="middle_3" pos="0 0 0">
                            <joint type="hinge" name="middle_joint_2" axis="1 0 0" pos="0.008 0.1218333 -0.01" range="-1 45"/> 
                            <geom type="mesh" mesh="middle_3" class="class2" mass = "0.1"/>

                            <!-- Virtual link for third rolling joint -->
                            <body name="middle_virtual_link_3" pos="0 0 0"> 
                                <joint type="hinge" name="middle_virtual_joint_3" axis="1 0 0" pos="0.008 0.1318333 -0.01" range="-1 45"/>               
                                <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 
                
                                <!-- Fourth link -->
                                <body name="middle_4" pos="0 0 0">
                                    <joint type="hinge" name="middle_joint_3" axis="1 0 0" pos="0.008 0.1518333 -0.01" range="-1 45"/> 
                                    <geom type="mesh" mesh="middle_4" class="class2" mass = "0.1"/>

                                </body>
                            </body>
                        </body>
                    </body>
                </body>
            </body>


            <!-- 3Dof finger ############################################################################################################-->
            <geom type="mesh" mesh="pinki_base" mass = "0.1" class="class1"/>

            <!-- First link (pin joint) -->
            <body name="pinki_1" pos="0 0 0">
                <joint type="hinge" name="pinki_joint_0" axis="0 0 1" pos="-0.0294176 0.0296474 -0.0028" range="0 120"/> 
                <geom type="mesh" mesh="pinki_1" class="class2" mass = "0.1"/>

                <!-- Virtual link for first rolling joint -->
                <body name="pinki_virtual_link_1" pos="0 0 0"> 
                    <joint type="hinge" name="pinki_virtual_joint_1" axis="1 0 0" pos="-0.032 0.0496474 -0.0108" range="-1 45"/>               
                    <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 

                    <!-- Second link -->
                    <body name="pinki_2" pos="0 0 0">
                        <joint type="hinge" name="pinki_joint_1" axis="1 0 0" pos="-0.032 0.0696474 -0.0108" range="-1 45"/> 
                        <geom type="mesh" mesh="pinki_2" class="class2" mass = "0.1"/>

                        <!-- Virtual link for second rolling joint -->
                        <body name="pinki_virtual_link_2" pos="0 0 0"> 
                            <joint type="hinge" name="pinki_virtual_joint_2" axis="1 0 0" pos="-0.032 0.0946474 -0.0108" range="-1 45"/>               
                            <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 
            
                            <!-- Third link -->
                            <body name="pinki_3" pos="0 0 0">
                                <joint type="hinge" name="pinki_joint_2" axis="1 0 0" pos="-0.032 0.1146474 -0.0108" range="-1 45"/> 
                                <geom type="mesh" mesh="pinki_3" class="class2" mass = "0.1"/>

                                <!-- Virtual link for third rolling joint -->
                                <body name="pinki_virtual_link_3" pos="0 0 0"> 
                                    <joint type="hinge" name="pinki_virtual_joint_3" axis="1 0 0" pos="-0.032 0.1246474 -0.0108" range="-1 45"/>               
                                    <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 
                    
                                    <!-- Fourth link -->
                                    <body name="pinki_4" pos="0 0 0">
                                        <joint type="hinge" name="pinki_joint_3" axis="1 0 0" pos="-0.032 0.1446474 -0.0108" range="-1 45"/> 
                                        <geom type="mesh" mesh="pinki_4" class="class2" mass = "0.1"/>

                                    </body>
                                </body>
                            </body>
                        </body>
                    </body>
                </body>
            </body>


            <!-- Thumb 4Dof finger ############################################################################################################-->
            <!-- First link dynamixel and thumb0 (pin joint ) -->
            <body name="dynamixel_thumb" pos="0 0 0">
                <joint type="hinge" name="thumb_joint_0" axis="0 0 1" pos="0 0 0" range="-30 90"/> 
                <geom type="mesh" mesh="dynamixel" class="class2" mass = "0.1"/>
                <geom type="mesh" mesh="thumb_1" class="class2" mass = "0.1"/>
    
                <!-- Second link -->
                <body name="thumb_2" pos="0 0 0">
                    <joint type="hinge" name="thumb_joint_1" axis="0 1 0" pos="0.0 -0.045 0.0065" range="-90 90"/> 
                    <geom type="mesh" mesh="thumb_2" class="class2" mass = "0.1"/>

                    <!-- Virtual link for first rolling joint -->
                    <body name="thumb_virtual_link_2" pos="0 0 0"> 
                        <joint type="hinge" name="thumb_virtual_joint_2" axis="-1 0 0" pos="-0.008 -0.0605 0.0265" range="-1 45"/>               
                        <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 
        
                        <!-- Third link -->
                        <body name="thumb_3" pos="0 0 0">
                            <joint type="hinge" name="thumb_joint_2" axis="-1 0 0" pos="-0.008 -0.0605 0.0465" range="-1 45"/> 
                            <geom type="mesh" mesh="thumb_3" class="class2" mass = "0.1"/>

                            <!-- Virtual link for second rolling joint -->
                            <body name="thumb_virtual_link_3" pos="0 0 0"> 
                                <joint type="hinge" name="thumb_virtual_joint_3" axis="-1 0 0" pos="-0.008 -0.0606 0.1065" range="-1 45"/>               
                                <inertial pos="0 0 0" mass="1e-6" diaginertia="1e-15 1e-15 1e-15" /> 
                
                                <!-- Fourth link -->
                                <body name="thumb_4" pos="0 0 0">
                                    <joint type="hinge" name="thumb_joint_3" axis="-1 0 0" pos="-0.008 -0.0606 0.1265" range="-1 45"/> 
                                    <geom type="mesh" mesh="thumb_4" class="class2" mass = "0.1"/>

                                </body>
                            </body>
                        </body>
                    </body>
                </body>
            </body>
        </body>
    </worldbody>

    <!-- neighboring bodies are excluded from contact calculation -->
    <contact>
        <!-- pointer -->
        <exclude body1="Palm" body2="pointer_2"/>
        <exclude body1="Palm" body2="pointer_virtual_link_1"/>
        <exclude body1="pointer_2" body2="pointer_virtual_link_1"/>

        <exclude body1="pointer_2" body2="pointer_3"/>
        <exclude body1="pointer_2" body2="pointer_virtual_link_2"/>
        <exclude body1="pointer_3" body2="pointer_virtual_link_2"/>

        <exclude body1="pointer_3" body2="pointer_4"/>
        <exclude body1="pointer_3" body2="pointer_virtual_link_3"/>
        <exclude body1="pointer_4" body2="pointer_virtual_link_3"/>

        <!-- middle -->
        <exclude body1="Palm" body2="middle_2"/>
        <exclude body1="Palm" body2="middle_virtual_link_1"/>
        <exclude body1="middle_2" body2="middle_virtual_link_1"/>

        <exclude body1="middle_2" body2="middle_3"/>
        <exclude body1="middle_2" body2="middle_virtual_link_2"/>
        <exclude body1="middle_3" body2="middle_virtual_link_2"/>

        <exclude body1="middle_3" body2="middle_4"/>
        <exclude body1="middle_3" body2="middle_virtual_link_3"/>
        <exclude body1="middle_4" body2="middle_virtual_link_3"/>

        <!-- pinki -->
        <exclude body1="Palm" body2="pinki_1"/>

        <exclude body1="pinki_1" body2="pinki_2"/>
        <exclude body1="pinki_1" body2="pinki_virtual_link_1"/>
        <exclude body1="pinki_2" body2="pinki_virtual_link_1"/>

        <exclude body1="pinki_2" body2="pinki_3"/>
        <exclude body1="pinki_2" body2="pinki_virtual_link_2"/>
        <exclude body1="pinki_3" body2="pinki_virtual_link_2"/>

        <exclude body1="pinki_3" body2="pinki_4"/>
        <exclude body1="pinki_3" body2="pinki_virtual_link_3"/>
        <exclude body1="pinki_4" body2="pinki_virtual_link_3"/>

        <!-- thumb -->
        <exclude body1="Palm" body2="dynamixel_thumb"/>

        <exclude body1="dynamixel_thumb" body2="thumb_2"/>

        <exclude body1="thumb_2" body2="thumb_3"/>
        <exclude body1="thumb_2" body2="thumb_virtual_link_2"/>
        <exclude body1="thumb_3" body2="thumb_virtual_link_2"/>

        <exclude body1="thumb_3" body2="thumb_4"/>
        <exclude body1="thumb_3" body2="thumb_virtual_link_3"/>
        <exclude body1="thumb_4" body2="thumb_virtual_link_3"/>
    </contact>


    <tendon >
        <!-- For rolling contact joints: Constrain virtual joint x to have the same angle as joint x -->
        <!-- Same for underactuated finger tips -->

        <!-- pointer -->
        <fixed name="constraint_pointer_joint_1">
            <joint joint="pointer_virtual_joint_1" coef="1"/>
            <joint joint="pointer_joint_1" coef="-1"/>
        </fixed>
        <fixed name="constraint_pointer_joint_2">
            <joint joint="pointer_virtual_joint_2" coef="1"/>
            <joint joint="pointer_joint_2" coef="-1"/>
        </fixed>
        <fixed name="constraint_pointer_joint_3">
            <joint joint="pointer_virtual_joint_3" coef="1"/>
            <joint joint="pointer_joint_3" coef="-1"/>
        </fixed>
        <fixed name="pointer_underactuation">
            <joint joint="pointer_joint_2" coef="1"/>
            <joint joint="pointer_joint_3" coef="-1"/>
        </fixed>

        <!-- middle -->
        <fixed name="constraint_middle_joint_1">
            <joint joint="middle_virtual_joint_1" coef="1"/>
            <joint joint="middle_joint_1" coef="-1"/>
        </fixed>
        <fixed name="constraint_middle_joint_2">
            <joint joint="middle_virtual_joint_2" coef="1"/>
            <joint joint="middle_joint_2" coef="-1"/>
        </fixed>
        <fixed name="constraint_middle_joint_3">
            <joint joint="middle_virtual_joint_3" coef="1"/>
            <joint joint="middle_joint_3" coef="-1"/>
        </fixed>
        <fixed name="middle_underactuation">
            <joint joint="middle_joint_2" coef="1"/>
            <joint joint="middle_joint_3" coef="-1"/>
        </fixed>

        <!-- pinki -->
        <fixed name="constraint_pinki_joint_1">
            <joint joint="pinki_virtual_joint_1" coef="1"/>
            <joint joint="pinki_joint_1" coef="-1"/>
        </fixed>
        <fixed name="constraint_pinki_joint_2">
            <joint joint="pinki_virtual_joint_2" coef="1"/>
            <joint joint="pinki_joint_2" coef="-1"/>
        </fixed>
        <fixed name="constraint_pinki_joint_3">
            <joint joint="pinki_virtual_joint_3" coef="1"/>
            <joint joint="pinki_joint_3" coef="-1"/>
        </fixed>
        <fixed name="pinki_underactuation">
            <joint joint="pinki_joint_2" coef="1"/>
            <joint joint="pinki_joint_3" coef="-1"/>
        </fixed>

        <!-- thumb -->
        <fixed name="constraint_thumb_joint_2">
            <joint joint="thumb_virtual_joint_2" coef="1"/>
            <joint joint="thumb_joint_2" coef="-1"/>
        </fixed>
        <fixed name="constraint_thumb_joint_3">
            <joint joint="thumb_virtual_joint_3" coef="1"/>
            <joint joint="thumb_joint_3" coef="-1"/>
        </fixed>
    </tendon>


    <actuator>
        <!-- for rolling contact: ctrl in radiant / 2 (because actually 2 joints per real joint) -->

        <!-- pointer -->
        <position joint="pointer_joint_1" kp="1" ctrlrange="0 0.7854 "/> 
        <position joint="pointer_joint_2" kp="1" ctrlrange="0 0.7854 "/> 

        <!-- middle -->
        <position joint="middle_joint_1" kp="1" ctrlrange="0 0.7854 "/> 
        <position joint="middle_joint_2" kp="1" ctrlrange="0 0.7854 "/> 

        <!-- pinki -->
        <position joint="pinki_joint_0" kp="1" ctrlrange="0 2 "/>  <!-- pin -->
        <position joint="pinki_joint_1" kp="1" ctrlrange="0 0.7854 "/> 
        <position joint="pinki_joint_2" kp="1" ctrlrange="0 0.7854 "/> 

        <!-- thumb -->
        <position joint="thumb_joint_0" kp="0.5" ctrlrange="-0.5236 1.5708"/>  <!-- pin -->
        <position joint="thumb_joint_1" kp="0.5" ctrlrange="-1.4 1.4"/> <!-- pin -->
        <position joint="thumb_joint_2" kp="1" ctrlrange="0 0.7854"/> 
        <position joint="thumb_joint_3" kp="1" ctrlrange="0 0.7854"/> 
    </actuator>
</mujoco>
